<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIBER MUSIC - Simulador de Cobro</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el tema Cyber Neon Morado */
        :root {
            --color-primary: #8B5CF6; /* Morado base */
            --color-secondary: #EC4899; /* Rosa neón */
            --color-text: #F3F4F6;
            --color-success: #10B981;
            --color-danger: #EF4444;
        }

        body {
            background-color: #111827; /* Fondo oscuro */
            color: var(--color-text);
            font-family: 'Inter', sans-serif;
        }

        .neon-text {
            color: var(--color-text);
            text-shadow: 0 0 7px var(--color-primary), 0 0 10px var(--color-primary), 0 0 21px var(--color-primary), 0 0 42px var(--color-secondary), 0 0 82px var(--color-secondary), 0 0 92px var(--color-secondary), 0 0 102px var(--color-secondary);
        }

        .card-machine {
            background-color: #1F2937;
            border: 2px solid var(--color-primary);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.5); /* Sombra neón */
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-machine:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.8);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            text-transform: uppercase;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        }

        .btn-start {
            background-color: var(--color-success);
            color: #1F2937;
        }
        .btn-start:hover {
            background-color: #059669;
            box-shadow: 0 0 10px var(--color-success);
            transform: scale(1.05);
        }

        .btn-stop {
            background-color: var(--color-danger);
            color: #1F2937;
        }
        .btn-stop:hover {
            background-color: #DC2626;
            box-shadow: 0 0 10px var(--color-danger);
            transform: scale(1.05);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Encabezado y Título -->
    <header class="text-center mb-10">
        <h1 class="text-4xl sm:text-6xl font-extrabold tracking-wider neon-text">
            CIBER MUSIC
        </h1>
        <p class="text-xl mt-2 text-gray-300">Simulador de Control de Máquinas y Cobros</p>
        <p id="user-info" class="text-sm text-gray-500 mt-2">ID de Usuario: Cargando...</p>
    </header>

    <!-- Contenedor principal de las máquinas -->
    <div id="machines-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
        <!-- Las tarjetas de máquina se insertarán aquí por JavaScript -->
        <div class="col-span-full text-center py-10" id="loading-indicator">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto"></div>
            <p class="mt-3 text-purple-400">Cargando estado de las máquinas...</p>
        </div>
    </div>

    <!-- Modal para el resumen de cobro -->
    <div id="modal-cobro" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md card-machine">
            <h2 class="text-3xl font-bold mb-4 neon-text" id="modal-title">Cobro Finalizado</h2>
            <div id="modal-content" class="text-lg space-y-2">
                <!-- Contenido del cobro -->
            </div>
            <button onclick="document.getElementById('modal-cobro').classList.add('hidden'); document.getElementById('modal-cobro').classList.remove('flex');" class="mt-6 btn bg-purple-600 hover:bg-purple-700 text-white w-full">Cerrar</button>
        </div>
    </div>

    <!-- Script de Firebase y lógica de la aplicación -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, serverTimestamp, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración inicial
        setLogLevel('Debug');
        const NUM_MACHINES = 6;
        const PRICE_PER_HOUR = 10.00; // Tarifa de ejemplo: $10 por hora

        // Variables globales
        let db;
        let auth;
        let userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Referencia a la colección pública de máquinas
        function getMachineCollectionRef() {
            // Usamos una colección pública para que el estado sea compartido entre todos los usuarios (como un sistema real)
            return collection(db, `artifacts/${appId}/public/data/cibermusic_machines`);
        }

        // Función de inicialización de Firebase
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticación: Usar token custom si está disponible, sino, anónima.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info').textContent = `ID de Usuario: ${userId}`;
                        setupRealtimeListener();
                        initMachines();
                    } else {
                        console.error("Autenticación fallida.");
                        document.getElementById('user-info').textContent = 'ID de Usuario: ERROR DE AUTENTICACIÓN';
                    }
                    document.getElementById('loading-indicator').classList.add('hidden');
                });
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                document.getElementById('loading-indicator').innerHTML = `<p class="text-red-500">Error al conectar con la base de datos.</p>`;
            }
        }

        // Función para inicializar las máquinas en Firestore si no existen
        async function initMachines() {
            const machineRef = getMachineCollectionRef();
            // Verificar si la colección ya tiene documentos (es suficiente verificar uno)
            const q = query(machineRef);
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                console.log("Inicializando las máquinas en Firestore.");
                for (let i = 1; i <= NUM_MACHINES; i++) {
                    const machineDocRef = doc(machineRef, `machine_${i}`);
                    await setDoc(machineDocRef, {
                        id: i,
                        status: 'LIBRE', // LIBRE o OCUPADO
                        startTime: null,
                        occupiedBy: null,
                        lastUpdateTime: serverTimestamp()
                    });
                }
            }
        }

        // Función principal para configurar el listener de tiempo real
        function setupRealtimeListener() {
            const machineRef = getMachineCollectionRef();
            onSnapshot(machineRef, (snapshot) => {
                const machines = [];
                snapshot.forEach(doc => {
                    machines.push(doc.data());
                });

                // Ordenar por ID para asegurar el orden (Máquina 1, 2, 3...)
                machines.sort((a, b) => a.id - b.id);
                renderMachines(machines);
            }, (error) => {
                console.error("Error al escuchar cambios en Firestore:", error);
            });
        }

        // Función para calcular tiempo y costo
        function calculateUsage(machine) {
            if (machine.status === 'OCUPADO' && machine.startTime) {
                const now = Date.now();
                // Firestore guarda serverTimestamp, que puede ser un objeto Timestamp o null.
                const startTimeMs = machine.startTime.toDate ? machine.startTime.toDate().getTime() : machine.startTime;

                const durationMs = now - startTimeMs;
                const durationSeconds = Math.floor(durationMs / 1000);
                const durationHours = durationMs / (1000 * 60 * 60);

                // Calcular el costo (Tarifa por hora / 60 minutos * minutos usados)
                const totalCost = durationHours * PRICE_PER_HOUR;

                // Formatear el tiempo (HH:MM:SS)
                const h = String(Math.floor(durationSeconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((durationSeconds % 3600) / 60)).padStart(2, '0');
                const s = String(durationSeconds % 60).padStart(2, '0');
                const timeStr = `${h}:${m}:${s}`;

                return { timeStr, totalCost };
            }
            return { timeStr: '00:00:00', totalCost: 0 };
        }

        // Función para renderizar el UI
        function renderMachines(machines) {
            const container = document.getElementById('machines-container');
            container.innerHTML = ''; // Limpiar contenedor
            
            machines.forEach(machine => {
                const machineElement = document.createElement('div');
                machineElement.className = 'card-machine rounded-lg p-5 flex flex-col justify-between h-56';
                machineElement.id = `machine-${machine.id}`;

                const { timeStr, totalCost } = calculateUsage(machine);

                // Determinar estilos y texto del botón
                let buttonText = machine.status === 'LIBRE' ? 'Iniciar Uso' : 'Finalizar Uso';
                let buttonClass = machine.status === 'LIBRE' ? 'btn-start' : 'btn-stop';
                let statusClass = machine.status === 'LIBRE' ? 'bg-green-500' : 'bg-red-500';

                // Contenido principal de la tarjeta
                machineElement.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-2xl font-bold text-white">Máquina ${machine.id}</h2>
                        <span class="status-badge ${statusClass} text-gray-900">${machine.status}</span>
                    </div>

                    ${machine.status === 'OCUPADO' ? `
                        <div class="space-y-2 mb-4">
                            <p class="text-sm text-gray-300">Inicio: <span class="font-mono text-lg text-purple-300">${machine.startTime.toDate ? machine.startTime.toDate().toLocaleTimeString() : 'N/A'}</span></p>
                            <p class="text-sm text-gray-300">Tiempo: <span class="font-mono text-lg text-yellow-300" id="time-${machine.id}">${timeStr}</span></p>
                            <p class="text-sm text-gray-300">Costo: <span class="font-mono text-xl neon-text">$${totalCost.toFixed(2)}</span></p>
                        </div>
                    ` : `
                        <p class="text-gray-400 my-auto text-center">¡Máquina disponible! Costo: $${PRICE_PER_HOUR.toFixed(2)} / hora.</p>
                        <div class="h-20"></div> <!-- Espaciador para mantener altura -->
                    `}

                    <button id="btn-${machine.id}" class="btn ${buttonClass} mt-auto w-full" data-machine-id="${machine.id}" data-status="${machine.status}">
                        ${buttonText}
                    </button>
                `;

                container.appendChild(machineElement);
                
                // Agregar el evento al botón
                machineElement.querySelector(`#btn-${machine.id}`).addEventListener('click', () => {
                    toggleMachineStatus(machine.id, machine.status, timeStr, totalCost);
                });
            });

            // Iniciar o actualizar el cronómetro si hay máquinas ocupadas
            if (machines.some(m => m.status === 'OCUPADO')) {
                // Si ya hay un intervalo, no crear otro
                if (!window.timerInterval) {
                     window.timerInterval = setInterval(() => {
                        // Recargar la interfaz cada segundo sin llamar a Firestore (solo la lógica de tiempo)
                        updateMachineTimes(machines);
                    }, 1000);
                }
            } else {
                // Si no hay máquinas ocupadas, detener el intervalo para ahorrar recursos
                if (window.timerInterval) {
                    clearInterval(window.timerInterval);
                    window.timerInterval = null;
                }
            }
        }

        // Función para actualizar los tiempos en el DOM (sin recargar de Firestore)
        function updateMachineTimes(machines) {
            machines.forEach(machine => {
                if (machine.status === 'OCUPADO' && machine.startTime) {
                    const { timeStr, totalCost } = calculateUsage(machine);
                    const timeSpan = document.getElementById(`time-${machine.id}`);
                    if (timeSpan) {
                        timeSpan.textContent = timeStr;
                        // Actualizar el costo, que está en un div no identificado, buscamos el padre
                        const costElement = timeSpan.parentElement.nextElementSibling.querySelector('.neon-text');
                        if (costElement) {
                            costElement.textContent = `$${totalCost.toFixed(2)}`;
                        }
                    }
                }
            });
        }

        // Función para manejar el cambio de estado (Click en botón)
        async function toggleMachineStatus(id, currentStatus, timeStr, totalCost) {
            const machineDocRef = doc(getMachineCollectionRef(), `machine_${id}`);

            if (currentStatus === 'LIBRE') {
                // Iniciar uso
                await updateDoc(machineDocRef, {
                    status: 'OCUPADO',
                    startTime: serverTimestamp(), // Marca de tiempo del servidor para precisión
                    occupiedBy: userId
                });
                console.log(`Máquina ${id} iniciada por ${userId}`);

            } else {
                // Finalizar uso
                // 1. Mostrar modal de cobro (usando el tiempo y costo calculados localmente)
                showCobroModal(id, timeStr, totalCost);

                // 2. Resetear el estado en Firestore
                await updateDoc(machineDocRef, {
                    status: 'LIBRE',
                    startTime: null,
                    occupiedBy: null
                });
                console.log(`Máquina ${id} liberada.`);
            }
        }

        // Función para mostrar el modal de cobro
        function showCobroModal(id, timeStr, totalCost) {
            const modal = document.getElementById('modal-cobro');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <p>Máquina: <span class="font-bold text-white">Máquina ${id}</span></p>
                <p>Tiempo de Uso: <span class="font-bold text-yellow-400">${timeStr}</span></p>
                <p>Costo por Hora: <span class="font-bold text-purple-400">$${PRICE_PER_HOUR.toFixed(2)}</span></p>
                <div class="border-t border-gray-700 pt-3 mt-3">
                    <p class="text-2xl font-extrabold text-white neon-text">TOTAL A COBRAR:</p>
                    <p class="text-4xl font-extrabold text-white neon-text text-center">$${totalCost.toFixed(2)}</p>
                </div>
                <p class="text-xs text-gray-500 mt-4 text-center">Datos guardados en Firestore para auditoría.</p>
            `;

            document.getElementById('modal-title').textContent = `Cobro Máquina ${id}`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Iniciar la aplicación
        initializeFirebase();
    </script>
</body>
</html>
